# bens-common 公共基础模块设计方案

> 文档版本: 1.0  
> 更新日期: 2026-01-21  
> 适用范围: bens 项目公共基础设施重构

---

## 目录

- [一、背景与目标](#一背景与目标)
- [二、模块结构规划](#二模块结构规划)
- [三、各子模块详细设计](#三各子模块详细设计)
- [四、依赖关系图](#四依赖关系图)
- [五、迁移计划](#五迁移计划)
- [六、收益分析](#六收益分析)

---

## 一、背景与目标

### 1.1 现状问题

当前项目的公共基础代码主要集中在 `bens-rule` 模块，存在以下问题：

1. **职责过重**: `bens-rule` 承载了工具类、异常体系、响应封装、树形结构等多种职责
2. **命名不当**: "规则模块"的命名与实际承载的基础设施代码不匹配
3. **复用困难**: 责任链框架分散在 `message-center-common`，其他模块无法复用
4. **依赖混乱**: 基础模块引入了 MyBatis-Plus、Servlet API 等，导致依赖传递过多

### 1.2 设计目标

1. 建立清晰的公共基础模块体系
2. 按职责拆分，降低模块耦合
3. 提供统一的异常、响应、分页等基础设施
4. 使责任链等设计模式可跨模块复用

---

## 二、模块结构规划

### 2.1 整体结构

```
bens-common/
├── pom.xml                           # 聚合父POM
│
├── common-core/                      # 核心基础模块 (零依赖)
│   └── src/main/java/.../common/core/
│       ├── constants/                # 公共常量
│       ├── enums/                    # 公共枚举
│       ├── base/                     # 基础接口
│       └── util/                     # 核心工具类
│
├── common-exception/                 # 统一异常模块
│   └── src/main/java/.../common/exception/
│       ├── ServiceException.java     # 业务异常基类
│       ├── AbstractExceptionEnum.java
│       └── enums/                    # 公共异常枚举
│
├── common-web/                       # Web相关模块
│   └── src/main/java/.../common/web/
│       ├── pojo/                     # 请求/响应封装
│       ├── util/                     # Web工具类
│       └── filter/                   # 公共过滤器
│
├── common-model/                     # 公共模型模块
│   └── src/main/java/.../common/model/
│       ├── tree/                     # 树形结构
│       ├── page/                     # 分页模型
│       └── dict/                     # 字典模型
│
└── common-chain/                     # 责任链框架模块
    └── src/main/java/.../common/chain/
        ├── ChainProcessor.java       # 责任链处理器
        ├── ChainAction.java          # Action接口
        ├── ChainContext.java         # 上下文接口
        └── BaseChainContext.java     # 上下文基类
```

### 2.2 子模块概览

| 子模块 | artifactId | 职责定位 | 外部依赖 |
|--------|------------|----------|----------|
| **common-core** | `common-core` | 最基础的工具类、常量、枚举 | lombok, hutool-core |
| **common-exception** | `common-exception` | 统一异常体系 | common-core |
| **common-web** | `common-web` | Web层封装（请求/响应/工具） | common-exception, servlet-api |
| **common-model** | `common-model` | 公共数据模型（树、分页、字典） | common-core |
| **common-chain** | `common-chain` | 责任链设计模式框架 | common-core, slf4j |

---

## 三、各子模块详细设计

### 3.1 common-core (核心基础模块)

**设计原则**: 零业务依赖，只依赖最基础的工具库

#### 包结构

```
cn.ibenbeni.bens.common.core
├── constants/
│   ├── SymbolConstant.java           # 符号常量
│   ├── TreeConstants.java            # 树形常量
│   └── RuleConstants.java            # 规则常量
│
├── enums/
│   ├── StatusEnum.java               # 状态枚举
│   ├── YesOrNotEnum.java             # 是否枚举
│   ├── SexEnum.java                  # 性别枚举
│   ├── DbTypeEnum.java               # 数据库类型
│   └── IsSysEnum.java                # 是否系统内置
│
├── base/
│   └── ReadableEnum.java             # 可读枚举接口
│
└── util/
    ├── CollectionUtils.java          # 集合工具
    ├── DateUtils.java                # 日期工具
    ├── JsonUtils.java                # JSON工具
    ├── BeanUtils.java                # Bean工具
    ├── ObjectUtils.java              # 对象工具
    ├── ArrayUtils.java               # 数组工具
    ├── SetUtils.java                 # Set工具
    └── TracerUtils.java              # 链路追踪工具
```

#### pom.xml 依赖

```xml
<dependencies>
    <dependency>
        <groupId>org.projectlombok</groupId>
        <artifactId>lombok</artifactId>
        <scope>provided</scope>
    </dependency>
    <dependency>
        <groupId>cn.hutool</groupId>
        <artifactId>hutool-core</artifactId>
    </dependency>
    <dependency>
        <groupId>com.fasterxml.jackson.core</groupId>
        <artifactId>jackson-annotations</artifactId>
        <optional>true</optional>
    </dependency>
</dependencies>
```

---

### 3.2 common-exception (统一异常模块)

**设计原则**: 提供统一的异常基类，各业务模块继承扩展

#### 包结构

```
cn.ibenbeni.bens.common.exception
├── ServiceException.java             # 业务异常基类
├── AbstractExceptionEnum.java        # 异常枚举抽象接口
│
└── enums/
    ├── CommonExceptionEnum.java      # 公共异常枚举
    ├── ServletExceptionEnum.java     # Servlet异常枚举
    └── DataScopeExceptionEnum.java   # 数据权限异常
```

#### 核心类设计

```java
/**
 * 业务异常基类
 */
public class ServiceException extends RuntimeException {
    
    /** 错误码 */
    private String errorCode;
    
    /** 用户提示信息 */
    private String userTip;
    
    /** 异常模块名称 */
    private String moduleName;
    
    /** 携带数据 */
    private Object data;
    
    // 构造函数...
}

/**
 * 异常枚举接口
 */
public interface AbstractExceptionEnum {
    String getErrorCode();
    String getUserTip();
}
```

#### pom.xml 依赖

```xml
<dependencies>
    <dependency>
        <groupId>cn.ibenbeni</groupId>
        <artifactId>common-core</artifactId>
        <version>${revision}</version>
    </dependency>
</dependencies>
```

---

### 3.3 common-web (Web相关模块)

**设计原则**: 封装Web层通用组件，依赖Servlet API

#### 包结构

```
cn.ibenbeni.bens.common.web
├── pojo/
│   ├── request/
│   │   └── BaseRequest.java          # 请求基类
│   │
│   └── response/
│       ├── ResponseData.java         # 统一响应封装
│       ├── SuccessResponseData.java  # 成功响应
│       └── ErrorResponseData.java    # 错误响应
│
├── util/
│   ├── HttpUtils.java                # HTTP工具
│   ├── WebUtils.java                 # Web工具
│   ├── ServletUtils.java             # Servlet工具
│   └── HttpServletUtil.java          # HttpServlet工具
│
├── filter/
│   └── constants/
│       └── WebFilterOrderConstants.java  # Filter顺序常量
│
└── handler/
    └── GlobalExceptionHandler.java   # 全局异常处理(可选)
```

#### 统一响应封装设计

```java
/**
 * 统一响应封装
 */
@Data
public class ResponseData<T> {
    
    /** 请求是否成功 */
    private Boolean success;
    
    /** 响应状态码 */
    private String code;
    
    /** 响应信息 */
    private String message;
    
    /** 响应数据 */
    private T data;
    
    // 静态工厂方法
    public static <T> ResponseData<T> success(T data) { ... }
    public static <T> ResponseData<T> error(String code, String message) { ... }
}
```

#### pom.xml 依赖

```xml
<dependencies>
    <dependency>
        <groupId>cn.ibenbeni</groupId>
        <artifactId>common-exception</artifactId>
        <version>${revision}</version>
    </dependency>
    <dependency>
        <groupId>javax.servlet</groupId>
        <artifactId>javax.servlet-api</artifactId>
        <scope>provided</scope>
    </dependency>
    <dependency>
        <groupId>org.springframework</groupId>
        <artifactId>spring-web</artifactId>
        <optional>true</optional>
    </dependency>
</dependencies>
```

---

### 3.4 common-model (公共模型模块)

**设计原则**: 提供跨模块复用的数据模型

#### 包结构

```
cn.ibenbeni.bens.common.model
├── tree/
│   ├── AbstractTreeNode.java         # 树节点抽象类
│   ├── AbstractTreeBuildFactory.java # 树构建工厂抽象类
│   ├── DefaultTreeBuildFactory.java  # 默认树构建实现
│   └── buildpids/
│       ├── BasePidBuildModel.java    # PID构建模型
│       └── PidStructureBuildUtil.java
│
├── page/
│   ├── PageRequest.java              # 分页请求
│   ├── PageResult.java               # 分页结果
│   └── SortField.java                # 排序字段
│
└── dict/
    └── SimpleDict.java               # 简单字典模型
```

#### 分页模型设计 (新增)

```java
/**
 * 统一分页请求
 */
@Data
public class PageRequest<T> {
    
    /** 页码，从1开始 */
    @NotNull
    @Min(1)
    private Integer pageNo = 1;
    
    /** 每页数量 */
    @NotNull
    @Min(1)
    @Max(100)
    private Integer pageSize = 10;
    
    /** 排序字段 */
    private List<SortField> sorts;
    
    /** 查询条件 */
    private T query;
}

/**
 * 统一分页结果
 */
@Data
public class PageResult<T> {
    
    /** 数据列表 */
    private List<T> list;
    
    /** 总记录数 */
    private Long total;
    
    /** 总页数 */
    private Integer pages;
    
    /** 当前页码 */
    private Integer pageNo;
    
    /** 每页数量 */
    private Integer pageSize;
    
    // 静态工厂方法
    public static <T> PageResult<T> of(List<T> list, long total, int pageNo, int pageSize) { ... }
}

/**
 * 排序字段
 */
@Data
public class SortField {
    /** 字段名 */
    private String field;
    /** 是否升序 */
    private Boolean asc = true;
}
```

#### pom.xml 依赖

```xml
<dependencies>
    <dependency>
        <groupId>cn.ibenbeni</groupId>
        <artifactId>common-core</artifactId>
        <version>${revision}</version>
    </dependency>
    <dependency>
        <groupId>javax.validation</groupId>
        <artifactId>validation-api</artifactId>
        <optional>true</optional>
    </dependency>
</dependencies>
```

---

### 3.5 common-chain (责任链框架模块)

**设计原则**: 提供通用的责任链模式实现，支持多模块复用

#### 包结构

```
cn.ibenbeni.bens.common.chain
├── ChainAction.java                  # Action接口
├── ChainContext.java                 # 上下文接口
├── BaseChainContext.java             # 上下文基类
├── ChainProcessor.java               # 责任链处理器
│
└── annotation/
    └── ChainOrder.java               # 排序注解(可选)
```

#### 核心接口设计

```java
/**
 * 责任链上下文接口
 */
public interface ChainContext {
    
    /** 是否中断 */
    boolean isInterrupted();
    
    /** 中断链路 */
    void interrupt(String errorMessage);
    
    /** 获取错误信息 */
    String getErrorMessage();
    
    /** 获取租户ID */
    Long getTenantId();
    
    /** 设置租户ID */
    void setTenantId(Long tenantId);
}

/**
 * 责任链上下文基类
 */
@Data
public class BaseChainContext implements ChainContext {
    
    private boolean interrupted = false;
    private String errorMessage;
    private Long tenantId;
    
    @Override
    public void interrupt(String errorMessage) {
        this.interrupted = true;
        this.errorMessage = errorMessage;
    }
}

/**
 * 责任链Action接口
 */
public interface ChainAction<T extends ChainContext> {
    
    /** 执行动作 */
    void execute(T context);
    
    /** 获取执行顺序，数值越小越先执行 */
    int getOrder();
}

/**
 * 责任链处理器
 */
@Slf4j
public class ChainProcessor<T extends ChainContext> {
    
    private final List<ChainAction<T>> actions;
    private final String chainName;
    
    public ChainProcessor(List<? extends ChainAction<T>> actions, String chainName) {
        this.actions = new ArrayList<>(actions);
        this.chainName = chainName;
        this.actions.sort(Comparator.comparingInt(ChainAction::getOrder));
    }
    
    public void execute(T context) {
        for (ChainAction<T> action : actions) {
            if (context.isInterrupted()) {
                log.warn("[ChainProcessor][{}][链路中断][Action: {}]", chainName, action.getClass().getSimpleName());
                break;
            }
            try {
                action.execute(context);
            } catch (Exception ex) {
                log.error("[ChainProcessor][{}][Action执行异常]", chainName, ex);
                context.interrupt("Action执行异常: " + ex.getMessage());
                break;
            }
        }
    }
}
```

#### pom.xml 依赖

```xml
<dependencies>
    <dependency>
        <groupId>cn.ibenbeni</groupId>
        <artifactId>common-core</artifactId>
        <version>${revision}</version>
    </dependency>
    <dependency>
        <groupId>org.slf4j</groupId>
        <artifactId>slf4j-api</artifactId>
    </dependency>
</dependencies>
```

---

## 四、依赖关系图

```
                    ┌─────────────────┐
                    │   common-core   │  ← 零外部依赖，最底层
                    │  (工具/常量/枚举) │
                    └────────┬────────┘
                             │
         ┌───────────────────┼───────────────────┐
         │                   │                   │
         ▼                   ▼                   ▼
┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐
│ common-exception│  │  common-model   │  │  common-chain   │
│   (异常体系)    │  │ (树/分页/字典)   │  │  (责任链框架)   │
└────────┬────────┘  └─────────────────┘  └─────────────────┘
         │
         ▼
┌─────────────────┐
│   common-web    │  ← 依赖 Servlet API
│ (请求/响应/工具) │
└─────────────────┘
```

### 模块间依赖矩阵

| 模块 | common-core | common-exception | common-web | common-model | common-chain |
|------|:-----------:|:----------------:|:----------:|:------------:|:------------:|
| common-core | - | - | - | - | - |
| common-exception | ✓ | - | - | - | - |
| common-web | ✓ | ✓ | - | - | - |
| common-model | ✓ | - | - | - | - |
| common-chain | ✓ | - | - | - | - |

---

## 五、迁移计划

### 5.1 阶段一：创建模块结构

1. 创建 `bens-common` 聚合模块
2. 创建 5 个子模块的 pom.xml
3. 在根 pom.xml 中添加 module 声明

### 5.2 阶段二：代码迁移

| 源位置 | 目标模块 | 迁移内容 |
|--------|----------|----------|
| `bens-rule/util/*` | common-core | 工具类 |
| `bens-rule/constants/*` | common-core | 常量 |
| `bens-rule/enums/*` | common-core | 枚举 |
| `bens-rule/base/*` | common-core | 基础接口 |
| `bens-rule/exception/*` | common-exception | 异常体系 |
| `bens-rule/pojo/response/*` | common-web | 响应封装 |
| `bens-rule/pojo/request/*` | common-web | 请求基类 |
| `bens-rule/tree/*` | common-model | 树形结构 |
| `bens-rule/pojo/dict/*` | common-model | 字典模型 |
| `message-center-common/chain/*` | common-chain | 责任链框架 |

### 5.3 阶段三：依赖更新

1. 修改 `bens-rule` 依赖 `common-core`、`common-exception`、`common-web`、`common-model`
2. 修改 `message-center-common` 依赖 `common-chain`
3. 逐步将各业务模块的直接依赖改为对应的 common 子模块

### 5.4 阶段四：清理重构

1. 删除 `bens-rule` 中已迁移的代码
2. 考虑重命名 `bens-rule` 或将其职责重新定义
3. 更新相关模块的 import 语句

---

## 六、收益分析

### 6.1 架构收益

| 收益项 | 说明 |
|--------|------|
| **职责清晰** | 每个子模块职责单一，易于理解和维护 |
| **依赖可控** | 按需引入，避免依赖传递过多 |
| **复用性强** | 责任链、分页等可跨模块复用 |
| **扩展方便** | 新增公共组件只需添加到对应模块 |

### 6.2 开发体验提升

1. **引入更精确**: 只需要工具类时引入 `common-core`，不会引入 Servlet API
2. **异常体系统一**: 所有模块继承 `ServiceException`，统一处理
3. **分页模型统一**: 不再各模块自定义分页请求/响应
4. **责任链复用**: message-center、auth 等模块可直接使用

### 6.3 风险评估

| 风险项 | 影响 | 缓解措施 |
|--------|------|----------|
| 迁移工作量 | 中 | 分阶段迁移，保持兼容 |
| 包路径变更 | 中 | 在 bens-rule 保留 deprecated 的转发类 |
| 编译依赖变化 | 低 | 确保依赖传递正确 |

---

## 附录：父 POM 配置示例

```xml
<!-- bens-common/pom.xml -->
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 
         http://maven.apache.org/xsd/maven-4.0.0.xsd">
    <modelVersion>4.0.0</modelVersion>
    
    <parent>
        <groupId>cn.ibenbeni</groupId>
        <artifactId>bens</artifactId>
        <version>${revision}</version>
        <relativePath>../pom.xml</relativePath>
    </parent>
    
    <packaging>pom</packaging>
    <artifactId>bens-common</artifactId>
    <description>公共基础模块</description>
    
    <modules>
        <module>common-core</module>
        <module>common-exception</module>
        <module>common-web</module>
        <module>common-model</module>
        <module>common-chain</module>
    </modules>
    
</project>
```
